// 一次性解决所有问题的指令

// ===== 修复通信问题 (解决持续弹出错误) =====
// 1. 更新后台脚本初始化逻辑
@@ -src/background/background.ts
// 添加Service Worker保活机制
let keepAliveInterval: NodeJS.Timeout | null = null;

function initServiceWorker() {
  // 防止Service Worker休眠
  keepAliveInterval = setInterval(() => {
    console.log('Keep service worker alive');
  }, 25000);
  
  // 注册消息监听器
  chrome.runtime.onMessage.addListener(handleMessage);
  chrome.runtime.onConnect.addListener(port => {
    console.log(`Connected to port: ${port.name}`);
    port.onDisconnect.addListener(() => console.log('Port disconnected'));
  });
  
  console.log('✅ Service Worker initialized');
}

// 初始化Service Worker
initServiceWorker();

// 2. 更新内容脚本连接逻辑
@@ -src/content/content.ts
// 确保在DOM就绪后发送连接消息
document.addEventListener('DOMContentLoaded', () => {
  if (isXiaohongshuPage()) {
    // 添加超时和重试机制
    const connectWithRetry = (attempt = 0) => {
      chrome.runtime.sendMessage({ type: 'CONNECT' }, (response) => {
        if (chrome.runtime.lastError) {
          if (attempt < 3) {
            setTimeout(() => connectWithRetry(attempt + 1), 500);
          } else {
            console.error('Connection failed after retries');
          }
          return;
        }
        console.log('Connected to background:', response?.status);
      });
    };
    
    connectWithRetry();
  }
});

// 3. 更新manifest权限配置
@@ -src/manifest.json
{
  "permissions": [
    "scripting",
    "activeTab",
    "storage",
    "tabs"
  ],
  "content_scripts": [
    {
      "matches": [
        "https://www.xiaohongshu.com/explore/*",
        "https://www.xiaohongshu.com/discovery/item/*"
      ],
      "js": ["content.js"],
      "css": ["content.css"],
      "run_at": "document_end"
    }
  ],
  "web_accessible_resources": [
    {
      "resources": ["assets/*"],
      "matches": ["https://www.xiaohongshu.com/*"]
    }
  ]
}

// ===== 修复配置加载问题 (解决配置选择器无响应) =====
// 1. 更新配置管理器
@@ -src/utils/configManager.ts
import { storage } from './storageManager';

export async function loadConfigs(): Promise<FeishuConfig[]> {
  try {
    // 确保存储准备就绪
    await storage.ready;
    
    const configsData = await storage.get('feishuConfigs');
    
    if (!configsData) {
      console.warn('No configurations found');
      return [];
    }
    
    // 安全反序列化
    try {
      return JSON.parse(configsData);
    } catch (e) {
      console.error('Config parse error:', e);
      return [];
    }
  } catch (error) {
    console.error('Failed to load configurations:', error);
    return [];
  }
}

// 2. 更新Popup初始化逻辑
@@ -src/popup/popup.ts
async function initializePopup() {
  try {
    // 等待存储管理器就绪
    await storage.ready;
    
    // 加载配置
    const configs = await loadConfigs();
    
    // 填充配置选择器
    if (configs.length > 0) {
      populateConfigSelector(configs);
      document.getElementById('config-select').disabled = false;
    } else {
      showWarning('没有找到配置', '请先添加飞书配置');
    }
  } catch (error) {
    console.error('Popup initialization failed:', error);
    showError('初始化失败', '无法加载配置');
  }
}

// 3. 增强存储管理器
@@ -src/utils/storageManager.ts
class StorageManager {
  // 添加安全JSON方法
  async getJson(key: string): Promise<any> {
    const data = await this.get(key);
    try {
      return data ? JSON.parse(data) : null;
    } catch (e) {
      throw new Error(`Failed to parse JSON for key ${key}`);
    }
  }
  
  async setJson(key: string, value: any): Promise<void> {
    const jsonStr = JSON.stringify(value);
    await this.set(key, jsonStr);
  }
}

// ===== 修复图标显示问题 =====
// 1. 更新Vite构建配置
@@ -vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      input: {
        popup: 'src/popup/popup.html',
        background: 'src/background/background.ts',
        content: 'src/content/content.ts',
        assets: 'src/assets' // 关键：添加assets入口
      },
      output: {
        assetFileNames: 'assets/[name].[ext]' // 保持原始文件名
      }
    }
  },
  plugins: [
    crx({ manifest })
  ]
});

// 2. 修复图标引用路径
@@ -src/popup/popup.html
<!-- 更新所有图标引用 -->
<button id="config-btn">
  
</button>

<button id="refresh-btn">
  
</button>

// 3. 更新manifest图标配置
@@ -src/manifest.json
{
  "web_accessible_resources": [
    {
      "resources": ["assets/*.svg", "assets/*.png"],
      "matches": ["https://www.xiaohongshu.com/*"]
    }
  ],
  "icons": {
    "16": "assets/icon-16.png",
    "32": "assets/icon-32.png",
    "48": "assets/icon-48.png",
    "128": "assets/icon-128.png"
  },
  "action": {
    "default_icon": {
      "16": "assets/icon-16.png",
      "32": "assets/icon-32.png"
    }
  }
}

// 4. 添加默认图标资源
+++ src/assets/icon-config.svg
<!-- 添加SVG图标内容 -->

+++ src/assets/icon-refresh.svg
<!-- 添加SVG图标内容 -->

+++ src/assets/icon-16.png
// 添加16px PNG图标

+++ src/assets/icon-32.png
// 添加32px PNG图标

+++ src/assets/icon-48.png
// 添加48px PNG图标

+++ src/assets/icon-128.png
// 添加128px PNG图标

// ===== 添加健康检查模块 =====
// 1. 创建健康检查模块
+++ src/utils/healthCheck.ts
export async function performHealthCheck() {
  return {
    storage: await checkStorage(),
    config: await checkConfigLoading(),
    assets: await checkAssets(),
    connection: await checkConnection(),
    allHealthy: true
  };
}

async function checkStorage() {
  try {
    await storage.set('healthcheck', 'test');
    await storage.get('healthcheck');
    return true;
  } catch {
    return false;
  }
}

// 2. 在后台初始化时调用健康检查
@@ -src/background/background.ts
async function initializeModules() {
  // 初始化后执行健康检查
  const health = await performHealthCheck();
  console.log('Health check:', health);
  
  if (!health.allHealthy) {
    console.error('Health check failed:', health);
  }
}

// ===== 添加日志系统 =====
+++ src/utils/logger.ts
export class Logger {
  static debug(...args: any[]) {
    if (process.env.NODE_ENV === 'development') {
      console.debug('[DEBUG]', ...args);
    }
  }
  
  static error(error: Error, context?: string) {
    console.error(`[ERROR] ${context || 'Unhandled error'}:`, error);
  }
}

// 在全局替换console.error
@@ -src/background/background.ts
console.error = Logger.error;

// ===== 初始化顺序控制 =====
@@ -src/background/background.ts
async function initializeModules() {
  // 1. 初始化日志
  Logger.debug('Initializing modules...');
  
  // 2. 初始化存储
  await storage.initialize();
  
  // 3. 初始化配置
  await configManager.initialize();
  
  // 4. 初始化通信
  await initCommunication();
  
  // 5. 健康检查
  const health = await performHealthCheck();
  Logger.debug('Health check result:', health);
}

// 应用启动
initializeModules();