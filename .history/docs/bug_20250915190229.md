// 文件: src/lib/feishu-api.ts

// 添加详细的API调试信息
export async function writeToFeishuTable(data: any, config: FeishuConfig) {
  // 打印完整配置用于调试
  console.debug('飞书配置:', {
    appToken: config.feishuAppToken,
    tableId: config.feishuTableId,
    token: config.feishuPersonalBaseToken
  });
  
  try {
    const response = await fetch(
      `https://open.feishu.cn/open-apis/bitable/v1/apps/${config.feishuAppToken}/tables/${config.feishuTableId}/records`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${config.feishuPersonalBaseToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            // 确保字段映射正确
            标题: data.title,
            作者: data.author,
            内容: data.content,
            // 其他字段...
          }
        })
      }
    );

    // 打印完整响应
    const result = await response.json();
    console.debug('飞书API响应:', {
      status: response.status,
      data: result
    });

    // 处理可能的403错误
    if (response.status === 403) {
      throw new Error(`无权限访问: ${result.msg || '检查Token权限'}`);
    }
    
    if (result.code !== 0) {
      throw new Error(`飞书API错误: ${result.msg} (code: ${result.code})`);
    }
    
    return result.data;
  } catch (error) {
    // 提供更具体的错误信息
    let errorMessage = '飞书写入失败';
    if (error.message.includes('403')) {
      errorMessage = '权限不足: 请检查飞书Token是否具有表格写入权限';
    } else if (error.message.includes('table_id')) {
      errorMessage = '表格ID错误: 请确认表格ID是否正确';
    }
    
    throw new Error(errorMessage);
  }
}

// 添加API权限测试功能
export async function testFeishuPermissions(config: FeishuConfig) {
  const testUrl = `https://open.feishu.cn/open-apis/bitable/v1/apps/${config.feishuAppToken}/tables/${config.feishuTableId}?view_id=${config.viewId}`;
  
  const response = await fetch(testUrl, {
    headers: {
      'Authorization': `Bearer ${config.feishuPersonalBaseToken}`
    }
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`权限测试失败: ${error.msg}`);
  }
  
  return true;
}