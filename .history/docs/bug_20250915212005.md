Update(src/options/options.js)
  ⎿ 替换debugTokenPermissions函数
  @@ -src/options/options.js
  async function debugTokenPermissions() {
    try {
      console.log('[DEBUG] 开始调试Token权限...');
      updateConnectionStatus("testing", "调试Token权限中...");
      
      // 获取配置
      console.log('[DEBUG] 获取配置...');
      const config = await chrome.storage.sync.get([
        'feishuAppId', 
        'feishuAppSecret', 
        'feishuPersonalBaseToken'
      ]);
      console.log('[DEBUG] 配置:', JSON.stringify(config, null, 2));
      
      let accessToken = config.feishuPersonalBaseToken;
      
      // Token获取逻辑
      if (!accessToken) {
        console.log('[DEBUG] 未找到保存的Token，尝试获取新Token...');
        
        const tokenUrl = 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal';
        console.log('[DEBUG] 请求URL:', tokenUrl);
        console.log('[DEBUG] 请求体:', JSON.stringify({
          app_id: config.feishuAppId,
          app_secret: config.feishuAppSecret
        }));
        
        const tokenResponse = await safeApiRequest(tokenUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            app_id: config.feishuAppId,
            app_secret: config.feishuAppSecret
          })
        });
        
        console.log('[DEBUG] Token响应状态:', tokenResponse.status);
        console.log('[DEBUG] Token响应头:', JSON.stringify([...tokenResponse.headers.entries()]));
        
        const tokenData = await tokenResponse.json();
        console.log('[DEBUG] Token响应数据:', JSON.stringify(tokenData, null, 2));
        
        if (tokenData.code !== 0) {
          throw new Error(`获取Token失败: ${tokenData.msg}`);
        }
        
        accessToken = tokenData.tenant_access_token;
        console.log('[DEBUG] 新Token获取成功:', accessToken);
      } else {
        console.log('[DEBUG] 使用已保存的Token:', accessToken);
      }
      
      // 权限信息获取
      const infoUrl = 'https://open.feishu.cn/open-apis/authen/v1/access_token_info';
      console.log('[DEBUG] 请求权限信息URL:', infoUrl);
      
      const infoResponse = await safeApiRequest(infoUrl, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      });
      
      console.log('[DEBUG] 权限信息响应状态:', infoResponse.status);
      console.log('[DEBUG] 权限信息响应头:', JSON.stringify([...infoResponse.headers.entries()]));
      
      // 检查内容类型
      const contentType = infoResponse.headers.get('content-type');
      console.log('[DEBUG] 内容类型:', contentType);
      
      if (!contentType || !contentType.includes('application/json')) {
        const body = await infoResponse.text();
        console.log('[DEBUG] 非JSON响应内容:', body);
        throw new Error(`无效的响应类型: ${contentType}`);
      }
      
      const tokenInfo = await infoResponse.json();
      console.log('[DEBUG] Token权限信息:', JSON.stringify(tokenInfo, null, 2));
      
      // ... [其余代码保持不变] ...
    } catch (error) {
      console.error('[DEBUG] 调试失败详情:', {
        message: error.message,
        stack: error.stack,
        config: config ? JSON.stringify(config, null, 2) : '未定义'
      });
      updateConnectionStatus("disconnected", "权限错误");
      showToast(`调试失败: ${error.message}`, 'error');
      throw error;
    }
  }