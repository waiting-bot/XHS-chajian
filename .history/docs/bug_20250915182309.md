// ===== 1. 修复Vite配置 =====
// 文件: vite.config.ts
import { defineConfig } from 'vite'
import { crx } from '@crxjs/vite-plugin'
import manifest from './src/manifest.json'

export default defineConfig({
  build: {
    rollupOptions: {
      input: {
        // 关键：添加所有必要的入口点
        background: 'src/background/background.ts',
        content: 'src/content/content.ts',
        popup: 'src/popup/popup.html',
        options: 'src/options/options.html'
      },
      output: {
        // 确保内容脚本为IIFE格式
        format: 'iife',
        entryFileNames: '[name].js',
        chunkFileNames: 'chunks/[name].js',
        assetFileNames: 'assets/[name].[ext]'
      }
    }
  },
  plugins: [
    crx({ 
      manifest,
      contentScripts: {
        // 禁用HMR防止重复加载
        hmr: false
      }
    })
  ]
})

// ===== 2. 修复Service Worker注册 =====
// 文件: src/background/background.ts
// 添加Service Worker生命周期日志
console.log('Service Worker 正在启动...')

chrome.runtime.onInstalled.addListener(() => {
  console.log('扩展已安装')
})

// 保持活跃的心跳机制
setInterval(() => {
  console.log('Service Worker 心跳')
}, 30000)

// 添加全局错误处理
window.addEventListener('error', (event) => {
  console.error('SW全局错误:', event.error)
})

// 文件: src/manifest.json
{
  "background": {
    "service_worker": "background.js", // 确保指向正确的文件名
    "type": "module"
  }
}

// ===== 3. 修复内容脚本 =====
// 文件: src/content/content.ts
// 添加防止重复加载的保护
if (window.__xhsContentScriptLoaded) {
  console.warn('内容脚本已加载，跳过重复注入')
  throw new Error('内容脚本重复注入')
}
window.__xhsContentScriptLoaded = true

// 移除所有import语句，改为直接实现
function extractNoteData() {
  // 实现采集逻辑...
  return {
    title: document.title,
    // 其他数据...
  }
}

// 消息处理
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'COLLECT_NOTE') {
    try {
      const data = extractNoteData()
      console.log('采集到的数据:', data)
      sendResponse({ success: true, data })
    } catch (error) {
      sendResponse({ success: false, error: error.message })
    }
    return true // 保持消息通道开放
  }
})

// ===== 4. 修复飞书API调用 =====
// 文件: src/lib/feishu-api.ts
export async function writeToFeishuTable(data: any, config: FeishuConfig) {
  // 使用正确的字段名
  const appToken = config.feishuAppToken;
  const accessToken = config.feishuPersonalBaseToken;
  const tableId = config.feishuTableId;
  
  if (!appToken || !accessToken || !tableId) {
    throw new Error('飞书配置不完整');
  }

  try {
    const response = await fetch(
      `https://open.feishu.cn/open-apis/bitable/v1/apps/${appToken}/tables/${tableId}/records`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            title: data.title,
            author: data.author,
            content: data.content,
            // 其他字段...
          }
        })
      }
    );

    const result = await response.json();
    
    // 完整的错误处理
    if (result.code !== 0) {
      throw new Error(`飞书API错误: ${result.msg} (code: ${result.code})`);
    }
    
    return result.data;
  } catch (error) {
    console.error('飞书写入失败:', error);
    throw error;
  }
}

// ===== 5. 统一状态管理 =====
// 文件: src/lib/state-manager.ts
export class CollectionState {
  static currentState: 'idle' | 'collecting' | 'uploading' | 'success' | 'error' = 'idle';
  static errorMessage: string | null = null;
  
  static startCollecting() {
    this.currentState = 'collecting';
    this.errorMessage = null;
  }
  
  static startUploading() {
    this.currentState = 'uploading';
  }
  
  static markSuccess() {
    this.currentState = 'success';
    setTimeout(() => this.reset(), 3000);
  }
  
  static markError(message: string) {
    this.currentState = 'error';
    this.errorMessage = message;
    setTimeout(() => this.reset(), 5000);
  }
  
  static reset() {
    this.currentState = 'idle';
    this.errorMessage = null;
  }
}

// 文件: src/popup/popup.ts
import { CollectionState } from '../lib/state-manager';

function updateUI() {
  const state = CollectionState.currentState;
  const error = CollectionState.errorMessage;
  
  // 根据状态更新UI
  switch(state) {
    case 'idle':
      // 显示初始状态
      break;
    case 'collecting':
      // 显示采集状态
      break;
    case 'uploading':
      // 显示上传状态
      break;
    case 'success':
      // 显示成功状态
      break;
    case 'error':
      // 显示错误状态
      break;
  }
}

// ===== 6. 添加调试工具 =====
// 文件: src/utils/debugger.ts
export function enableDebugMode() {
  // 在URL中添加debug参数启用调试
  if (new URLSearchParams(window.location.search).has('debug')) {
    console.debug('调试模式已启用');
    
    // 暴露内部状态到全局
    window.debug = {
      reloadContentScript: () => {
        chrome.tabs.query({active: true}, (tabs) => {
          if (tabs[0].id) {
            chrome.tabs.reload(tabs[0].id);
          }
        });
      },
      testFeishu: async () => {
        // 测试飞书连接
      },
      getState: () => CollectionState.currentState
    };
  }
}