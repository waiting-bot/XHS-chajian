// 1. 修复飞书API调用中的字段映射问题（使用中文字段名）
Update(src/lib/feishu-api.ts)
  // 修改字段映射，使用中文字段名
  @@ -src/lib/feishu-api.ts
  export async function writeToFeishuTable(data: any, config: FeishuConfig) {
    try {
      // ... [其他代码] ...

      const payload = {
        fields: {
          - "title": data.title,
          - "author": data.author,
          - "content": data.content,
          + "标题": data.title || "",
          + "作者": data.author || "",
          + "正文": data.content || "",
          + "标签": data.tags ? data.tags.join('、') : "",
          + "点赞": data.likes || 0,
          + "收藏": data.favorites || 0,
          + "评论": data.comments || 0,
          + "url": data.url || "",
          + "笔记分析": data.analysis || "",
          + "采集备注": data.notes || ""
        }
      };

      // ... [其他代码] ...
    }
  }

// 2. 在选项页面添加调试按钮
Write(src/options/options.html)
  // 在表单中添加调试按钮
  +++ src/options/options.html
  <div class="form-group">
    <button type="button" id="debugTokenBtn" class="btn btn-debug">
      <i class="icon-bug"></i> 调试Token权限
    </button>
  </div>

// 3. 添加调试功能实现
Write(src/options/options.js)
  // 添加完整的调试功能实现
  +++ src/options/options.js
  async function debugTokenPermissions() {
    try {
      console.log('开始调试Token权限...');
      updateConnectionStatus("testing", "调试Token权限中...");
      
      // 获取配置
      const config = await chrome.storage.sync.get([
        'feishuAppId', 
        'feishuAppSecret', 
        'feishuPersonalBaseToken'
      ]);
      
      let accessToken = config.feishuPersonalBaseToken;
      
      // 如果没有保存的Token，获取新的
      if (!accessToken) {
        console.log('未找到保存的Token，尝试获取新Token...');
        
        const tokenResponse = await fetch('https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            app_id: config.feishuAppId,
            app_secret: config.feishuAppSecret
          })
        });
        
        const tokenData = await tokenResponse.json();
        if (tokenData.code !== 0) {
          throw new Error(`获取Token失败: ${tokenData.msg}`);
        }
        
        accessToken = tokenData.tenant_access_token;
        console.log('新Token获取成功:', accessToken);
      }
      
      // 获取权限信息
      console.log('获取Token权限信息...');
      const infoResponse = await fetch('https://open.feishu.cn/open-apis/authen/v1/access_token_info', {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      });
      
      const tokenInfo = await infoResponse.json();
      console.log('Token权限信息:', tokenInfo);
      
      // 检查关键权限
      if (tokenInfo.code === 0) {
        const requiredPermissions = [
          'bitable:record:write', 
          'bitable:table:write',
          'bitable:table:read'
        ];
        
        const grantedPermissions = tokenInfo.data.granted_scopes || [];
        
        console.log('已授予的权限:', grantedPermissions);
        
        // 检查缺失权限
        const missingPermissions = requiredPermissions.filter(perm => 
          !grantedPermissions.some(scope => scope.includes(perm))
        );
        
        if (missingPermissions.length > 0) {
          throw new Error(`缺少以下权限: ${missingPermissions.join(', ')}`);
        }
        
        updateConnectionStatus("connected", "Token权限正常");
        showToast('Token权限检查通过!', 'success');
      } else {
        throw new Error(`获取权限信息失败: ${tokenInfo.msg}`);
      }
      
      return tokenInfo;
    } catch (error) {
      console.error('调试失败:', error);
      updateConnectionStatus("disconnected", "权限错误");
      showToast(`调试失败: ${error.message}`, 'error');
      throw error;
    }
  }

  // 绑定按钮事件
  document.getElementById('debugTokenBtn').addEventListener('click', async () => {
    setButtonLoading(document.getElementById('debugTokenBtn'), true);
    try {
      await debugTokenPermissions();
    } catch (error) {
      // 错误已在函数内处理
    } finally {
      setButtonLoading(document.getElementById('debugTokenBtn'), false);
    }
  });

// 4. 添加调试按钮样式
Write(src/options/options.css)
  // 添加调试按钮样式
  +++ src/options/options.css
  .btn-debug {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
  }

  .btn-debug:hover {
    background-color: #5a6268;
  }

  .btn-debug i {
    margin-right: 5px;
  }

// 5. 修复Token字段名不一致问题
Update(src/options/options.js)
  // 确保所有地方使用feishuPersonalBaseToken
  @@ -src/options/options.js
  // 在配置对象中
  const config = {
    // ... [其他字段] ...
    - feishuAccessToken: '',
    + feishuPersonalBaseToken: '',
  }

  // 在保存配置时
  await chrome.storage.sync.set({
    // ... [其他字段] ...
    - feishuAccessToken: config.feishuAccessToken,
    + feishuPersonalBaseToken: config.feishuPersonalBaseToken,
  });

  // 在测试API时
  - let accessToken = config.feishuAccessToken;
  + let accessToken = config.feishuPersonalBaseToken;

// 6. 构建并测试
Bash(pnpm build)