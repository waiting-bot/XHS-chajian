// ===== 修复存储同步问题 =====
// 首先，确保配置页面和popup使用相同的存储键名
@@ -src/options/options.ts
// 在保存配置的部分，确保使用正确的键名
chrome.storage.sync.set({
  feishuAppToken: appToken,
  feishuPersonalBaseToken: personalToken,
  feishuTableId: tableId,
  // 添加一个标志表示配置已完成
  isConfigured: true
}, () => {
  showToast('配置保存成功!', 'success');
});

// ===== 修复 popup.ts 中的配置读取 =====
@@ -src/popup/popup.ts
// 修改 updateConfigStatus 函数，确保正确处理存储读取
async function updateConfigStatus(): Promise<ConfigStatus> {
  try {
    return new Promise((resolve) => {
      chrome.storage.sync.get([
        'feishuAppToken', 
        'feishuPersonalBaseToken',
        'feishuTableId',
        'isConfigured'
      ], (result) => {
        // 检查所有必需的配置项
        const hasAppToken = !!result.feishuAppToken;
        const hasPersonalToken = !!result.feishuPersonalBaseToken;
        const hasTableId = !!result.feishuTableId;
        const isConfigured = hasAppToken && hasPersonalToken && hasTableId;
        
        resolve({
          isConfigured,
          lastUpdated: new Date().toLocaleTimeString(),
          details: {
            hasAppToken,
            hasPersonalToken,
            hasTableId
          }
        });
      });
    });
  } catch (error) {
    console.error('获取配置状态失败:', error);
    return {
      isConfigured: false,
      error: error.message,
      lastUpdated: new Date().toLocaleTimeString()
    };
  }
}

// ===== 增强错误处理和调试信息 =====
// 修改 renderConfigStatus 函数，显示更多详细信息
function renderConfigStatus(status: ConfigStatus) {
  const statusEl = document.getElementById('configStatus');
  if (!statusEl) return;
  
  statusEl.innerHTML = '';
  
  const statusIcon = document.createElement('span');
  statusIcon.className = status.isConfigured ? 'status-icon success' : 'status-icon error';
  statusIcon.textContent = status.isConfigured ? '✓' : '✗';
  
  const statusText = document.createElement('span');
  statusText.className = 'status-text';
  statusText.textContent = status.isConfigured 
    ? '配置完整' 
    : '配置缺失或错误';
  
  const timeText = document.createElement('small');
  timeText.className = 'status-time';
  timeText.textContent = status.lastUpdated ? `更新于: ${status.lastUpdated}` : '';
  
  statusEl.appendChild(statusIcon);
  statusEl.appendChild(statusText);
  statusEl.appendChild(timeText);
  
  // 添加调试信息（仅在开发模式下显示）
  if (process.env.NODE_ENV === 'development' && status.details) {
    const debugInfo = document.createElement('div');
    debugInfo.className = 'debug-info';
    debugInfo.innerHTML = `
      <small>调试信息:<br>
      AppToken: ${status.details.hasAppToken ? '有' : '无'}<br>
      PersonalToken: ${status.details.hasPersonalToken ? '有' : '无'}<br>
      TableId: ${status.details.hasTableId ? '有' : '无'}
      </small>
    `;
    statusEl.appendChild(debugInfo);
  }
  
  if (status.error) {
    const errorText = document.createElement('div');
    errorText.className = 'status-error';
    errorText.textContent = `错误: ${status.error}`;
    statusEl.appendChild(errorText);
  }
}

// ===== 添加存储读取重试机制 =====
// 在 DOMContentLoaded 事件处理中添加重试逻辑
document.addEventListener('DOMContentLoaded', async () => {
  let retryCount = 0;
  const maxRetries = 3;
  
  const loadConfigWithRetry = async () => {
    try {
      const initialStatus = await updateConfigStatus();
      renderConfigStatus(initialStatus);
      
      // 如果配置不完整且还有重试次数，稍后重试
      if (!initialStatus.isConfigured && retryCount < maxRetries) {
        retryCount++;
        setTimeout(loadConfigWithRetry, 1000);
      }
    } catch (error) {
      console.error('加载配置失败:', error);
      if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(loadConfigWithRetry, 1000);
      }
    }
  };
  
  // 初始加载
  loadConfigWithRetry();
  
  // 其余代码保持不变...
});

// ===== 添加调试样式 =====
@@ -src/popup/popup.css
.debug-info {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background-color: #f1f8ff;
  border: 1px solid #c8e1ff;
  border-radius: 4px;
  font-family: monospace;
  font-size: 0.75rem;
}

// ===== 修复配置页面保存后的同步问题 =====
@@ -src/options/options.ts
// 在保存成功后，发送消息通知popup更新
chrome.storage.sync.set({
  feishuAppToken: appToken,
  feishuPersonalBaseToken: personalToken,
  feishuTableId: tableId,
  isConfigured: true
}, () => {
  showToast('配置保存成功!', 'success');
  
  // 通知popup页面更新状态
  chrome.runtime.sendMessage({
    type: 'configUpdated',
    data: {
      feishuAppToken: appToken,
      feishuPersonalBaseToken: personalToken,
      feishuTableId: tableId
    }
  });
});

// ===== 在popup中添加消息监听 =====
@@ -src/popup/popup.ts
// 添加消息监听器
chrome.runtime.onMessage.addListener((message) => {
  if (message.type === 'configUpdated') {
    // 配置已更新，立即刷新状态
    updateConfigStatus().then((newStatus) => {
      renderConfigStatus(newStatus);
      
      // 显示更新通知
      const notice = document.createElement('div');
      notice.className = 'update-notice';
      notice.textContent = '配置已更新!';
      document.body.appendChild(notice);
      
      setTimeout(() => {
        notice.remove();
      }, 2000);
    });
  }
});