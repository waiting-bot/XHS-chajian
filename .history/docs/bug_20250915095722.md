# Chrome扩展优化任务说明书

## 项目背景
我们正在开发一款Chrome扩展程序，用于采集小红书笔记数据并写入飞书多维表格。项目采用Vite + CRXJS + TypeScript技术栈，核心功能已完成，现需进行以下优化：

## 任务列表

### 1. Popup界面全面优化
**目标**：创建更直观、信息更丰富的用户界面  
**文件**：`src/popup/`目录下相关文件  
**要求**：
- 实现五区域布局：
  - **状态显示区**：实时页面检测状态、飞书连接状态、系统健康状态
  - **配置管理区**：配置选择器（支持多配置）、配置管理按钮（新增/编辑/删除）、测试连接按钮、列映射可视化
  - **数据预览区**：标题预览（50字符+展开）、作者信息（名称+头像）、内容摘要（100字符+展开）、互动数据、媒体预览（图片轮播+视频缩略图）
  - **操作控制区**：刷新数据按钮、开始采集按钮（带状态切换）、暂停/恢复按钮、上传进度条
  - **错误处理区**：用户友好错误消息、可展开详情、情境感知重试按钮、错误报告功能
- 使用响应式设计确保在不同尺寸下正常显示
- 添加操作状态视觉反馈

### 2. 存储系统健壮性增强
**目标**：解决"Invalid storage key: undefined"错误  
**文件**：`src/utils/storageManager.ts`  
**要求**：
```typescript
class StorageManager {
  private readyPromise: Promise<void>;
  
  constructor() {
    this.readyPromise = this.initializeStorage();
  }
  
  private async initializeStorage() {
    // 初始化chrome.storage
    return new Promise((resolve) => {
      chrome.storage.local.get(null, () => resolve());
    });
  }
  
  get ready() {
    return this.readyPromise;
  }
  
  async get(key: string): Promise<any> {
    await this.ready;
    if (!this.validateKey(key)) throw new Error(`Invalid key: ${key}`);
    return new Promise((resolve) => {
      chrome.storage.local.get([key], (result) => resolve(result[key]));
    });
  }
  
  // set和remove方法同样实现
  
  private validateKey(key: string): boolean {
    return typeof key === 'string' && key.length > 0 && /^[\w-]+$/.test(key);
  }
}