<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°çº¢ä¹¦é‡‡é›†å™¨</title>
    <link rel="stylesheet" href="popup.css" />
  </head>
  <body>
    <div class="app-container">
      <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
      <header class="app-header">
        <div class="header-content">
          <div class="app-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
              <path d="M2 17L12 22L22 17"/>
              <path d="M2 12L12 17L22 12"/>
            </svg>
          </div>
          <div class="app-title">
            <h1>å°çº¢ä¹¦é‡‡é›†å™¨</h1>
            <div class="app-subtitle">æ•°æ®é‡‡é›†ä¸é£ä¹¦åŒæ­¥å·¥å…·</div>
          </div>
        </div>
      </header>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <main class="app-main">
        <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
        <div class="status-card">
          <div class="card-header">
            <h2 class="card-title">ç³»ç»ŸçŠ¶æ€</h2>
            <div class="status-indicator">
              <div class="indicator-dot loading" id="pageStatusDot"></div>
              <span class="status-text" id="pageStatusText">æ£€æµ‹ä¸­...</span>
            </div>
          </div>
          <div class="card-content">
            <div class="page-info" id="pageInfo">
              <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>æ­£åœ¨æ£€æµ‹é¡µé¢çŠ¶æ€</span>
              </div>
            </div>
          </div>
        </div>

        <!-- é…ç½®ç®¡ç†åŒº -->
        <div class="config-card">
          <div class="card-header">
            <h2 class="card-title">é£ä¹¦é…ç½®</h2>
            <div class="config-manager-buttons">
              <button class="icon-button" id="testConnection" title="æµ‹è¯•è¿æ¥" aria-label="æµ‹è¯•è¿æ¥">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z"/>
                </svg>
              </button>
              <button class="icon-button" id="manageConfigs" title="ç®¡ç†é…ç½®" aria-label="ç®¡ç†é…ç½®">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M12 1V6"/>
                  <path d="M12 18V23"/>
                  <path d="M4.22 4.22L7.76 7.76"/>
                  <path d="M16.24 16.24L19.78 19.78"/>
                  <path d="M1 12H6"/>
                  <path d="M18 12H23"/>
                  <path d="M4.22 19.78L7.76 16.24"/>
                  <path d="M16.24 7.76L19.78 4.22"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="config-selector">
              <div class="config-selector-group">
                <select class="modern-select" id="configSelector">
                  <option value="">é€‰æ‹©é…ç½®...</option>
                </select>
                <button class="icon-button" id="refreshConfigs" title="åˆ·æ–°é…ç½®" aria-label="åˆ·æ–°é…ç½®">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 4V10H7"/>
                    <path d="M23 20V14H17"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15"/>
                  </svg>
                </button>
              </div>
              <div class="config-status" id="configStatus">
                <!-- é…ç½®çŠ¶æ€å°†åŠ¨æ€æ¸²æŸ“åœ¨è¿™é‡Œ -->
              </div>
            </div>
          </div>
        </div>

        <!-- æ•°æ®é¢„è§ˆåŒº -->
        <div class="preview-card" id="previewCard" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">æ•°æ®é¢„è§ˆ</h2>
            <button class="expand-button" id="togglePreview" title="å±•å¼€/æ”¶èµ·">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9L12 15L18 9"/>
              </svg>
            </button>
          </div>
          <div class="card-content" id="previewContent">
            <div class="loading-state">
              <div class="loading-spinner"></div>
              <span>æ­£åœ¨é‡‡é›†æ•°æ®...</span>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæ§åˆ¶åŒº -->
        <div class="action-section">
          <button class="primary-button" id="startCollection" disabled>
            <span class="button-icon">â–¶</span>
            <span>å¼€å§‹é‡‡é›†</span>
          </button>
          <button class="secondary-button" id="pauseCollection" disabled>
            <span class="button-icon">â¸</span>
            <span>æš‚åœ</span>
          </button>
          <button class="ghost-button" id="refreshData">
            <span class="button-icon">â†»</span>
            <span>åˆ·æ–°æ•°æ®</span>
          </button>
          <button class="debug-button" id="debug-storage" title="æ£€æŸ¥å­˜å‚¨">
            <span class="button-icon">ğŸ”</span>
            <span>æ£€æŸ¥å­˜å‚¨</span>
          </button>
        </div>

        <!-- é”™è¯¯å¤„ç†åŒº -->
        <div class="error-notification-container top-right" id="errorContainer">
          <!-- é”™è¯¯é€šçŸ¥å°†åŠ¨æ€æ¸²æŸ“åœ¨è¿™é‡Œ -->
        </div>
      </main>

      <!-- åº•éƒ¨çŠ¶æ€æ  -->
      <footer class="app-footer">
        <div class="footer-content">
          <div class="footer-status" id="footerStatus">
            å°±ç»ª
          </div>
          <div class="connection-status">
            <div class="status-dot offline" id="connectionDot"></div>
            <span id="connectionText">æœªè¿æ¥</span>
          </div>
        </div>
      </footer>
    </div>

    <!-- é…ç½®ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="config-modal" id="configModal" style="display: none;">
      <div class="modal-overlay" id="modalOverlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">ç¼–è¾‘é…ç½®</h3>
          <button class="close-button" id="closeModal" aria-label="å…³é—­">Ã—</button>
        </div>
        <div class="modal-body">
          <form id="configForm" class="config-form">
            <div class="form-field">
              <label class="field-label">é…ç½®åç§° *</label>
              <input type="text" class="modern-input" id="configName" placeholder="è¯·è¾“å…¥é…ç½®åç§°" required>
            </div>
            
            <div class="form-field">
              <label class="field-label">å¤šç»´è¡¨æ ¼URL *</label>
              <input type="url" class="modern-input" id="tableUrl" placeholder="https://example.feishu.cn/base/xxxx" required>
              <div class="field-help">è¯·è¾“å…¥é£ä¹¦å¤šç»´è¡¨æ ¼çš„å®Œæ•´URLåœ°å€</div>
            </div>
            
            <div class="form-field">
              <label class="field-label">APP ID *</label>
              <input type="text" class="modern-input" id="appId" placeholder="cli_xxxxxx" required>
              <div class="field-help">é£ä¹¦åº”ç”¨çš„APP IDï¼Œæ ¼å¼å¦‚ cli_xxxxxx</div>
            </div>
            
            <div class="form-field">
              <label class="field-label">APP Secret *</label>
              <div class="password-input">
                <input type="password" class="modern-input" id="appSecret" placeholder="è¯·è¾“å…¥APP Secret" required>
                <button type="button" class="password-toggle" id="toggleSecret" aria-label="æ˜¾ç¤º/éšè—å¯†é’¥">ğŸ‘</button>
              </div>
              <div class="field-help">é£ä¹¦åº”ç”¨çš„APP Secretå¯†é’¥</div>
            </div>
            
            <div class="form-field">
              <label class="field-label">å¤‡æ³¨</label>
              <textarea class="modern-textarea" id="configNotes" placeholder="é…ç½®å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div class="config-actions">
            <button type="button" class="ghost-button" id="cancelConfig">å–æ¶ˆ</button>
            <button type="button" class="secondary-button" id="testConfigBtn">æµ‹è¯•è¿æ¥</button>
            <button type="button" class="primary-button" id="saveConfig">ä¿å­˜é…ç½®</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ (å¼€å‘æ—¶ä½¿ç”¨) -->
    <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; z-index: 10000; display: none; font-size: 12px; border-radius: 8px; max-width: 300px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <strong>è°ƒè¯•ä¿¡æ¯</strong>
        <button onclick="document.getElementById('debug-panel').style.display='none'" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">Ã—</button>
      </div>
      <div id="debug-content"></div>
      <div style="margin-top: 8px;">
        <button onclick="window.debugForceShowModal && window.debugForceShowModal()" style="background: #007aff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 4px; font-size: 11px;">å¼ºåˆ¶æ˜¾ç¤ºæ¨¡æ€æ¡†</button>
        <button onclick="window.checkIcons && window.checkIcons()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">æ£€æŸ¥å›¾æ ‡</button>
      </div>
    </div>

    <script type="module" src="popup.ts"></script>
    <script>
      // å…¨å±€è°ƒè¯•å‡½æ•°
      window.debugForceShowModal = function() {
        const modal = document.getElementById('configModal');
        if (modal) {
          modal.style.display = 'block';
          modal.style.setProperty('display', 'block', 'important');
          document.body.style.overflow = 'hidden';
          console.log('[Debug] æ¨¡æ€æ¡†å·²å¼ºåˆ¶æ˜¾ç¤º');
        } else {
          console.error('[Debug] æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
        }
      };

      window.checkIcons = function() {
        const iconButtons = document.querySelectorAll('.icon-button');
        const report = {
          totalIconButtons: iconButtons.length,
          details: []
        };
        
        iconButtons.forEach((btn, index) => {
          const svg = btn.querySelector('svg');
          report.details.push({
            index: index,
            hasSVG: !!svg,
            svgContent: svg ? svg.outerHTML.substring(0, 100) : 'No SVG',
            buttonClass: btn.className,
            buttonHTML: btn.innerHTML.substring(0, 50)
          });
        });
        
        console.log('[Debug] å›¾æ ‡æ£€æŸ¥æŠ¥å‘Š:', report);
        alert('å›¾æ ‡æ£€æŸ¥æŠ¥å‘Šå·²è¾“å‡ºåˆ°æ§åˆ¶å°');
      };

      // Ctrl+Shift+D æ˜¾ç¤ºè°ƒè¯•é¢æ¿
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
          const panel = document.getElementById('debug-panel');
          if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          }
        }
      });
    </script>
  </body>
</html>
